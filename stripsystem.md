# Stripchat Data Automation System (Plan)

このドキュメントは、Stripchatの配信データを全自動で収集・蓄積し、プレミアムなUIで可視化するためのシステム構築計画です。

## 1. システム概要
ユーザーが配信中またはオフライン時であっても、バックグラウンドでシステムが自動的に外部データ（StripHours等）を定期巡回し、独自のデータベースに保存・蓄積します。

### 主な目標
- **手動操作の最小化**: 一度データを貼り付ければ、自動的にデータベースに保存され、次からは選択するだけで表示可能。
- **データの永続化**: 外部サイトから消えてしまう可能性のある過去の3分ごとの詳細データを、自分のCloudflare KVに一生分蓄積する。
- **高精細な操作感**: 蓄積された膨大なデータを、超ワイドなチャートで快適に分析できるUIの提供。

---

## 2. 実装コンポーネント (実装済み)

### A. API Layer (Cloudflare Pages Functions)
- **ファイル**: `functions/api/sessions.js`
- **動作**: 
    - `POST`: 受け取った `charData` を解析し、日付ごとにKV（データベース）へ保存。
    - `GET`: 保存されている日付リストの取得、または特定の日付の詳細データの引き出し。

### B. Storage (Cloudflare KV)
- **Namespace**: `STRIP_DATA`
- **ID**: `e5d87a3383d040dbb20191a8994bd8b5`
- **構造**: `session_YYYY-MM-DD` というキーで各配信のJSONデータを保存。

### C. Analyzer UI (アップグレード済み)
- **ファイル**: `stripchat/index.html`, `stripchat/js/app.js`
- **新機能**:
    - **履歴選択**: 保存された過去の配信をドロップダウンメニューから即座に切り替え。
    - **自動同期**: 手動でデータを貼り付けた際、バックグラウンドで自動的にデータベースへ送信。

---

## 3. 今後の拡張 (Phase 2 & 3)

| 項目 | 内容 |
| :--- | :--- |
| **完全自動収集** | Cloudflare Workersの Cron Trigger を使い、手動貼り付けすら不要にする定期巡回機能。 |
| **高度な統計** | 月間累計数値の算出や、他サービスとのデータ連携。 |

---

## 4. 再構築時の注意点 (別アカウントへの移行など)

1.  **KVの作成**: 新しいアカウントで `wrangler kv namespace create STRIP_DATA` を実行。
2.  **IDの置換**: 出力された新しい `id` を `wrangler.toml` に書き換える。
3.  **デプロイ**: `npx wrangler pages deploy .` で再展開。

---

## 5. 現在のステータス
- **[2026-01-04]**: 初期インフラ (KV + API + UI) 構築完了。履歴保存機能が稼働開始。
